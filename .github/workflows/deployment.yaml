name: Deploy Process

on:
    push:
        branches:
            - main
jobs:
    deploy:
        name: üîß Deployment on docker
        runs-on: kaotice
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: üßπ Clean and copy to /opt/services/klickum-process
              run: |
                echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S mkdir -p /opt/services/klickum-process
                echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S rm -rf /opt/services/klickum-process/*
                echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S rsync -av --exclude='.git' --exclude='.github' ./ /opt/services/klickum-process/
                cd ../..
                if [ -f .env ]; then
                  echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S cp .env /opt/services/klickum-process/.env
                fi
            - name: üöÄ Deploy with docker-compose
              run: |
                  echo "‚è¨ Apagando contenedores actuales..."
                  echo "${{ secrets.SUDO_PASSWORD }}" | docker compose down
                  echo "üöÄ Levantando servicios actualizados..."
                  echo "${{ secrets.SUDO_PASSWORD }}" | docker compose up -d --build
